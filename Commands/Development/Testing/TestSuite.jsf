/*
  DONE:
  - output test log to file
  - open a blank document before we start
    - newdoc = fw.createFireworksDocument(size, res, backgroundColor);

  TODO:
  - use test files for heavyweight stuff (400 elements resize, 6000x6000 canvas...)
    - fw.openDocument(fileURL string or array);
  - test text-box vertical resizing
  - test all commands
*/

// we need an empty document to start running tests
var empty_doc = fw.createFireworksDocument({x:400,y:400}, {pixelsPerUnit:72, units:"inch"}, '#ffffff00');
var oc_folder = 'file:///P128/Users/ale/Documents/Code/Fireworks';

try {
  fw.runScript(fw.currentScriptDir + '/bstest.js');
} catch(e) {
  alert(e);
}


// Start test
log('Running TestSuite in ' + fw.appName);

start_time = new Date();

test('Test Suite runs setup', function(){
  assert_equal( 'There is one item created and selected', fw.selection.length, 1);
});
assert_equal('Test Suite runs teardown', fw.selection.length,0);


// API
test('Array extensions are defined', function(){
  assert_equal( 'Array.clone is defined', typeof(fw.selection.clone), "function" );
  assert_equal( 'Array.each is defined', typeof(fw.selection.each), "function" );
  assert_equal( 'Array.each_with_index is defined', typeof(fw.selection.each_with_index), "function" );
  assert_equal( 'Array.is_group is defined', typeof(fw.selection[0].is_group), "function" );
  assert_equal( 'Number.times is defined', typeof((5).times), "function" );
  assert_equal( 'Array.each_in_group is defined', typeof(fw.selection[0].each_in_group), 'function');
});

test('Array extensions work', function(){
  var a     = [0,1,2,3,4,5,6,7,8,9],
      count = 0;

  a.each(function(p){
    count++;
  });

  assert_equal( 'Array.each works', count, a.length );

  count = 0;
  a.each_with_index(function(p,index){
    count += index;
  });
  assert_equal( 'Array.each_with_index works', count, 9+8+7+6+5+4+3+2+1 );

  var b = a.clone();
  assert_equal('Array.clone works',b[4],4);
});


// Align: DONE
test( 'Align commands: Center', function(){

  fw.getDocumentDOM().selectAll();
  fw.selection[0].left = 100 * Math.random();
  fw.selection[0].top = 100 * Math.random();
  run_command('Align', 'Center on Canvas - Horizontal');
  assert_equal('Object is centered horizontally', fw.selection[0].left, 150);

  fw.getDocumentDOM().selectAll();
  fw.selection[0].left = 100 * Math.random();
  fw.selection[0].top = 100 * Math.random();
  run_command('Align', 'Center on Canvas - Vertical');
  assert_equal('Object is centered vertically', fw.selection[0].top, 150);

  fw.getDocumentDOM().selectAll();
  fw.selection[0].left = 100 * Math.random();
  fw.selection[0].top = 100 * Math.random();
  run_command('Align', 'Center on Canvas - Both');
  assert_equal('Object is centered horizontally', fw.selection[0].left, 150);
  assert_equal('Object is centered vertically', fw.selection[0].top, 150);

  fw.getDocumentDOM().addNewText({left:0, top:0, right:100, bottom:20}, true);
  fw.getDocumentDOM().setTextRuns({ initialAttrs:{ alignment:"center", antiAliasSharpness:192, antiAliasStrength:64, baselineShift:0, bold:false, face:"Arial", fillColor:"#666666", horizontalScale:1, italic:false, leading:1, leadingMode:"percentage", overSample:8, paragraphIndent:0, paragraphSpacingAfter:0, paragraphSpacingBefore:0, rangeKerning:0, size:"10pt", underline:false }, textRuns:[ { changedAttrs:{  }, characters:"fafdsfadsfasdfads" } ] });
  run_command('Select','Text Objects');
  run_command('Align', 'Center on Canvas - Horizontal');
  assert_equal('Text box is centered horizontally', Selection.left(), Math.round(fw.getDocumentDOM().width/2 - Selection.width()/2));
  run_command('Align', 'Center on Canvas - Vertical');
  assert_equal('Text box is centered vertically', Selection.top(), Math.round(fw.getDocumentDOM().height/2 - Selection.height()/2));
  fw.selection[0].left = 100 * Math.random();
  fw.selection[0].top = 100 * Math.random();
  run_command('Align', 'Center on Canvas - Both');
  assert('Text box is centered in both directions', (Selection.left() == Math.round(fw.getDocumentDOM().width/2 - Selection.width()/2)) && (Selection.top() == Math.round(fw.getDocumentDOM().height/2 - Selection.height()/2)));

});
test( 'Align commands: Space', function(){
  (3).times(add_rectangle);
  prompt_return = 10;
  fw.getDocumentDOM().selectAll();
  run_command('Align','Space Horizontal');
  assert_equal('Elements are spaced horizontally',Selection.width(),430);
  fw.getDocumentDOM().selectAll();
  run_command('Align','Space Vertical');
  assert_equal('Elements are spaced vertically',Selection.height(),430);
});


// Alpha: DONE
test( 'Alpha commands', function(){
  // This is a *very* bad test, but that's just because Fireworks does some funky stuff with opacity...
  run_command("Alpha","Alpha 10");
  assert_equal( 'Alpha 10 works', Math.round(fw.selection[0].opacity),10);
  run_command("Alpha","Alpha 20");
  assert_equal( 'Alpha 20 works', Math.round(fw.selection[0].opacity),20);
  run_command("Alpha","Alpha 30");
  assert_equal( 'Alpha 30 works', Math.round(fw.selection[0].opacity),30);
  run_command("Alpha","Alpha 40");
  assert_equal( 'Alpha 40 works', Math.round(fw.selection[0].opacity),40);
  run_command("Alpha","Alpha 50");
  assert_equal( 'Alpha 50 works', Math.round(fw.selection[0].opacity),50);
  run_command("Alpha","Alpha 60");
  assert_equal( 'Alpha 60 works', Math.round(fw.selection[0].opacity),60);
  run_command("Alpha","Alpha 70");
  assert_equal( 'Alpha 70 works', Math.round(fw.selection[0].opacity),70);
  run_command("Alpha","Alpha 80");
  assert_equal( 'Alpha 80 works', Math.round(fw.selection[0].opacity),80);
  run_command("Alpha","Alpha 90");
  assert_equal( 'Alpha 90 works', Math.round(fw.selection[0].opacity),90);
  run_command("Alpha","Alpha 100");
  assert_equal( 'Alpha 100 works', Math.round(fw.selection[0].opacity),100);
});


// Canvas: DONE
test( 'Canvas', function(){
  prompt_return = 110;
  run_command("Canvas","Canvas Width");
  assert_equal('Canvas Width is 110', fw.getDocumentDOM().width, 110);
  run_command("Canvas","Canvas Height");
  assert_equal('Canvas Height is 110', fw.getDocumentDOM().height, 110);
  prompt_return = '100,100';
  run_command("Canvas","Canvas Size");
  assert_equal('Canvas Size sets Width', fw.getDocumentDOM().width, 100);
  assert_equal('Canvas Size sets Height', fw.getDocumentDOM().height, 100);
});


// Color
test('Color',function(){
  prompt_return = '#00ff00';
  run_command('Color','Canvas Color');
  assert_equal('Canvas Color sets color', fw.getDocumentDOM().backgroundColor,'#00ff00');
  run_command('Color','Fill Color');
  assert_equal('Fill Color sets Color', fw.selection[0].pathAttributes.fillColor,'#00ff00');
  run_command('Color','Stroke Color');
  assert_equal('Fill Color sets Stroke', fw.selection[0].pathAttributes.brushColor,'#00ff00');
  fw.getDocumentDOM().selectAll();
  fw.getDocumentDOM().group("normal");
  run_command('Color','Fill Color');
  Selection.each(function(e){
    assert_equal('Fill Color sets color of elements inside groups', e.pathAttributes.fillColor, '#00ff00');
  });
});


// Effects
// No idea how I should test these, so I just basically run them all and expect Fireworks not to explode
test('Effects: Graphic',function(){
  run_command('Effects','Lightbox');
  run_command('Effects','Plastic');
  prompt_return = 50;
  run_command('Effects','Reflection');
  run_command('Effects','Safe Flatten');
});

// Repeat commands can be tested properly
test('Effects: Repeat Horizontal', function(){
  prompt_return = 10;
  run_command('Effects', 'Repeat Horizontal');
  fw.getDocumentDOM().selectAll();
  assert_equal('Item is repeated 10 times', fw.selection.length, 11);
  assert_equal('Item is spaced properly', Selection.width(), ((11 * 100) + (10 * 10)));
});

test('Effects: Repeat Vertical', function(){
  prompt_return = 10;
  run_command('Effects', 'Repeat Vertical');
  fw.getDocumentDOM().selectAll();
  assert_equal('Item is repeated 10 times', fw.selection.length, 11);
  assert_equal('Item is spaced properly', Selection.height(), ((11 * 100) + (10 * 10)));
});


// Export
test('Export',function(){
  run_command('Pages','Add Page');

  prompt_folder = oc_folder + '/tmp';
  Files.deleteFileIfExisting(prompt_folder);
  Files.createDirectory(prompt_folder);

  run_command('Export','All Pages as PNG 24 in');
  assert_equal('All pages are exported', Files.enumFiles(prompt_folder).length, 2);
});


// Export Settings
test('Export Settings',function(){
  // TODO: check all pages in multipage document
  run_command('Export Settings','Set PNG 24 for All Pages');
  assert_equal('PNG is set as export setting for all pages', fw.getDocumentDOM().exportOptions.exportFormat, 'PNG');
});

// Grids


// Guides


// Pages
// tests: numbers are added in the correct order (actually fixed in 51a672b5d4 (FIXED: Pages Â» Numberize was numbering in reverse order, due to the changes in ad324885b5 (Use inverse loops everywhere). Fix by @inefable))
test('Page commands', function(){
  assert_equal('Document has one page',fw.getDocumentDOM().pagesCount,1);
  run_command('Pages', 'Add Page');
  assert_equal('A page is added when running the Add Page command',fw.getDocumentDOM().pagesCount,2);
});

// Position
test('Position',function(){
  fw.selection[0].left = 100.2;
  fw.selection[0].top = 100.2;
  run_command('Position','Fix Position');
  assert_equal('Element x position is rounded', fw.selection[0].left, 100);
  assert_equal('Element y position is rounded', fw.selection[0].top, 100);

  prompt_return = '100,100';
  run_command('Position','Set Position');
  assert_equal('Element is moved to x position', fw.selection[0].left, 100);
  assert_equal('Element is moved to y position', fw.selection[0].top, 100);

  // Math operations
  prompt_return = '100*2,100';
  run_command('Position','Set Position');
  assert_equal('set_position works with maths operations', fw.selection[0].left, 200);

  // Objects with border
  fw.getDocumentDOM().setBrushNColor({ alphaRemap:"none", angle:0, antiAliased:true, aspect:100, blackness:0, category:"bc_Pencil", concentration:100, dashOffSize1:2, dashOffSize2:2, dashOffSize3:2, dashOnSize1:8, dashOnSize2:1, dashOnSize3:1, diameter:24, feedback:"brush", flowRate:0, maxCount:15, minSize:1, name:"bn_1-Pixel Anti-Aliased", numDashes:0, shape:"circle", softenMode:"bell curve", softness:0, spacing:15, textureBlend:0, textureEdge:0, tipColoringMode:"random", tipCount:1, tipSpacing:0, tipSpacingMode:"random", type:"simple" }, "#000066");
  fw.getDocumentDOM().setBrushPlacement('center');
  prompt_return = '100,100';
  run_command('Position','Set Position');
  assert_equal('set_position works properly for objects with border', fw.selection[0].left, 100);

  fw.getDocumentDOM().setBrushPlacement('outside');
  prompt_return = '100,100';
  run_command('Position','Set Position');
  assert_equal('set_position works properly for objects with border', fw.selection[0].left, 100);

  fw.getDocumentDOM().setBrushPlacement('inside');
  prompt_return = '100,100';
  run_command('Position','Set Position');
  assert_equal('set_position works properly for objects with border', fw.selection[0].left, 100);

  // TODO: Position works properly for text objects

  // Position works for bitmap objects
  fw.getDocumentDOM().selectAll();
  fw.getDocumentDOM().flattenSelection();
  prompt_return = '130,100';
  run_command('Position','Set Position');
  assert_equal('set_position works properly for bitmaps', fw.selection[0].left, 130);

});

// Properties: DONE
test('Properties',function(){
  prompt_return = 10;
  run_command('Properties','Set Rectangle Roundness in Pixels');
  var sel = fw.selection[0];
  var border_radius = 0;
  if (sel.roundness) {
    if(sel.mode == 'exact') {
      border_radius = sel.roundness;
    } else {
      border_radius = (sel.roundness * sel.height) / 2;
    }
  };
  assert_equal('Rectangle roundness is set properly', border_radius, 10);
});

// Select
test( 'Select text objects', function(){
  fw.getDocumentDOM().addNewText({left:0, top:0, right:100, bottom:20}, true);
  fw.getDocumentDOM().setTextRuns({ initialAttrs:{ alignment:"center", antiAliasSharpness:192, antiAliasStrength:64, baselineShift:0, bold:false, face:"Arial", fillColor:"#666666", horizontalScale:1, italic:false, leading:1, leadingMode:"percentage", overSample:8, paragraphIndent:0, paragraphSpacingAfter:0, paragraphSpacingBefore:0, rangeKerning:0, size:"10pt", underline:false }, textRuns:[ { changedAttrs:{  }, characters:"fafdsfadsfasdfads" } ] });
  fw.getDocumentDOM().addNewText({left:0, top:20, right:100, bottom:20}, true);
  fw.getDocumentDOM().setTextRuns({ initialAttrs:{ alignment:"center", antiAliasSharpness:192, antiAliasStrength:64, baselineShift:0, bold:false, face:"Arial", fillColor:"#666666", horizontalScale:1, italic:false, leading:1, leadingMode:"percentage", overSample:8, paragraphIndent:0, paragraphSpacingAfter:0, paragraphSpacingBefore:0, rangeKerning:0, size:"10pt", underline:false }, textRuns:[ { changedAttrs:{  }, characters:"fafdsfadsfasdfads" } ] });

  run_command('Select','Text Objects');
  assert_equal('Two text boxes are selected', fw.selection.length, 2);
});

// Size
test( 'Size command, single object', function(){
  assert_equal('An item is selected and its width is 100', fw.selection[0].width, 100);
  run_command("Size","Width +1");
  assert_equal('Selected item is 1 pixel wider', fw.selection[0].width, 101);
  run_command("Size","Width +10");
  assert_equal('Selected item is 10 pixels wider', fw.selection[0].width, 111);
  run_command("Size","Height +1");
  assert_equal('Selected item is 1 pixel taller', fw.selection[0].height, 101);
  run_command("Size","Height +10");
  assert_equal('Selected item is 10 pixels taller', fw.selection[0].height, 111);
  run_command("Size","Width -1");
  assert_equal('Selected item is 1 pixel narrower', fw.selection[0].width, 110);
  run_command("Size","Width -10");
  assert_equal('Selected item is 10 pixels narrower', fw.selection[0].width, 100);
  run_command("Size","Height -1");
  assert_equal('Selected item is 1 pixel shorter', fw.selection[0].height, 110);
  run_command("Size","Height -10");
  assert_equal('Selected item is 10 pixels shorter', fw.selection[0].height, 100);
});

test( 'Size command, multiple objects', function(){
  assert_equal('One item is selected', fw.selection.length,1);
  (30).times(add_rectangle);
  fw.getDocumentDOM().selectAll();
  assert_equal('Multiple items are selected', fw.selection.length, 31);
  run_command("Size","Width +10");
  assert_equal('Multiple items are 10 pixels wider', Selection.get_bounds().right,110);
  run_command("Size","Height +10");
  assert_equal('Multiple items are 10 pixels taller', Selection.get_bounds().bottom,110);
});

xtest( 'Size command, multiple objects [STRESS TEST]', function(){
  var max_rects = 599; // 599 work (9205ms), 600 rectangles crash CS5
  assert_equal('One item is selected', fw.selection.length,1);
  (max_rects - 1).times(add_rectangle);
  fw.getDocumentDOM().selectAll();
  assert_equal('Multiple items are selected', fw.selection.length, max_rects);
  run_command("Size","Width +10");
  assert_equal('Multiple items are 10 pixels wider', Selection.get_bounds().right,110);
  run_command("Size","Height +10");
  assert_equal('Multiple items are 10 pixels taller', Selection.get_bounds().bottom,110);
});

test( 'Size command, groups', function(){
  (30).times(add_rectangle);
  fw.getDocumentDOM().selectAll();
  fw.getDocumentDOM().group("normal");
  run_command('Size','Width +10');
  assert_equal('Group is resized',Selection.get_bounds().right,110);
});

test('Text boxes are resized properly', function(){
  // add text boxes
  fw.getDocumentDOM().addNewText({left:0, top:0, right:100, bottom:20}, true);
  fw.getDocumentDOM().setTextRuns({ initialAttrs:{ alignment:"center", antiAliasSharpness:192, antiAliasStrength:64, baselineShift:0, bold:false, face:"Arial", fillColor:"#666666", horizontalScale:1, italic:false, leading:1, leadingMode:"percentage", overSample:8, paragraphIndent:0, paragraphSpacingAfter:0, paragraphSpacingBefore:0, rangeKerning:0, size:"10pt", underline:false }, textRuns:[ { changedAttrs:{  }, characters:"fafdsfadsfasdfads" } ] });
  fw.getDocumentDOM().addNewText({left:0, top:20, right:100, bottom:20}, true);
  fw.getDocumentDOM().setTextRuns({ initialAttrs:{ alignment:"center", antiAliasSharpness:192, antiAliasStrength:64, baselineShift:0, bold:false, face:"Arial", fillColor:"#666666", horizontalScale:1, italic:false, leading:1, leadingMode:"percentage", overSample:8, paragraphIndent:0, paragraphSpacingAfter:0, paragraphSpacingBefore:0, rangeKerning:0, size:"10pt", underline:false }, textRuns:[ { changedAttrs:{  }, characters:"fafdsfadsfasdfads" } ] });

  run_command('Select','Text Objects');
  assert_equal('Two text boxes exist', fw.selection.length, 2);

  fw.selection.each_with_index(function(textbox,index){
    assert_equal('Text box ' + index + ' is 100 pixels wide', textbox.width, 104); // stupid Fireworks
  });

  // Resize ungrouped
  run_command('Select','Text Objects');
  run_command('Size', 'Width +10');
  fw.selection.each_with_index(function(textbox,index){
    assert_equal('Text box ' + index + ' is resized when not grouped', textbox.width, 114); // stupid Fireworks
  });

  // Create a group
  fw.getDocumentDOM().selectAll();
  fw.getDocumentDOM().group("normal");

  run_command('Select','Text Objects');
  run_command('Size', 'Width +10');
  fw.selection.each_with_index(function(textbox,index){
    assert_equal('Text box ' + index + ' is resized when grouped', textbox.width, 124); // stupid Fireworks
  },true);
});

// Text
test('Text commands', function(){
  
});


// End test ////////////////////////////////////////////////////////////////////////////
msg = '\n' + fw.appName + ": " + asserts + ' asserts, ' + ok + ' ok, ' + fail + ' failed. Test run in ' + (new Date() - start_time) + ' ms.';
log(msg);

function fix_date(num){
  num = num.toString();
  if (num.length < 2) {
    num = "0" + num;
  };
  return num;
}

var d = new Date();
var year = d.getFullYear();
var month = fix_date((d.getMonth() + 1));
var day = fix_date(d.getDate());
var hour = fix_date(d.getHours());
var minute = fix_date(d.getMinutes());
var seconds = fix_date(d.getSeconds());
var milliseconds = fix_date(d.getMilliseconds());
var folder_name = year + month + day + hour + minute + seconds + milliseconds;

File.create(test_output, oc_folder + '/logs/test_' + folder_name + '_' + fw.appName.replace(' ','_') + '.txt');

fw.closeDocument(empty_doc,false);
